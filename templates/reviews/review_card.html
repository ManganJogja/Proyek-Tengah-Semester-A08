{% extends 'base.html' %}
{% load static %}

{% block content %}
{% include 'navbar.html' %}
<div class="mt-16" style="min-height: 80vh; padding: 20px;">
    <div class="container">

        <!-- Restaurant Name Section -->
        <div style="text-align: left;">
            <h1 style="font-family: 'Abhaya Libre', sans-serif; font-weight: bold; font-size: 50px; margin-bottom: 10px;">
                Gudeg Yudjum
            </h1>
            <p style="color: rgb(0, 0, 0); font-size: 16px; margin-bottom: 30px;">Jalan Wijilan No.167 Yogyakarta</p>
        </div>

        <!-- Reviews Section -->
        <div style="text-align: left;">
            <h2 style="font-family: 'Abhaya Libre', sans-serif; font-weight: bold; font-size: 25px; margin-bottom: 20px;">
                All Reviews ({{ reviews.count }})
            </h2>
        </div>

        <!-- Reviews Grid -->
        <div class="row">
            <div class="reviews-container" style="display: flex; flex-wrap: wrap; gap: 20px; justify-content: flex-start;">
                {% for review in reviews %}
                <div class="review-card" id="review-card-{{ review.id }}" style="flex: 0 0 300px; max-width: 300px; min-height: 250px; border: 1px solid #ddd; padding: 20px; border-radius: 8px; background-color: #fff;">
                    <div class="card-body">
                        
                        <!-- Rating -->
                        <div style="margin: 10px 0;">
                            {% for i in "12345" %}
                                {% if forloop.counter <= review.rating %}
                                    <span class="fa fa-star text-warning"></span>
                                {% else %}
                                    <span class="fa fa-star text-secondary"></span>
                                {% endif %}
                            {% endfor %}
                        </div>
        
                        <!-- Username -->
                        <div>
                            <strong>{{ review.user.username }}</strong>
                        </div>
                        
                        <br>
                        <!-- Comment -->
                        <p class="card-text" style="color: rgb(90, 78, 78); font-size: 18px">"{{ review.comment }}"</p>
                        <br>
                        <!-- Post Date -->
                        <p class="text-muted" style="color: rgb(187, 170, 170); font-size: 12px">Posted on {{ review.created_at|date:"F d, Y" }}</p>
        
                        <!-- Edit and Delete Buttons, only if the logged-in user is the owner of the review -->
                        {% if review.user == request.user %}
                        <div style="display: flex; justify-content: space-between;">
                            <!-- Edit Button -->
                            <a href="{% url 'edit_review' review.id %}" class="edit-review-btn" data-id="{{ review.id }}" style="font-size: 14px; padding: 5px 10px; border-radius: 5px;">
                                <img src="{% static 'image/edit.png' %}" alt="Edit" style="width: 20px; height: 20px;">
                            </a>
                            <!-- Delete Button -->
                            <button class="delete-review-btn" data-id="{{ review.id }}" style="font-size: 14px; padding: 5px 10px; border-radius: 5px; background-color: transparent; border: none;">
                                <img src="{% static 'image/delete.png' %}" alt="Delete" style="width: 20px; height: 20px;">
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    
        <!-- Button for adding new review -->
        <div class="mb-3"><br><br><br>
            <a href="{% url 'add_review' %}" class="add-review-btn">Add New Review</a>
        </div>
    </div>
</div>
</div>
{% include 'footer.html' %}

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    // AJAX Delete Review
    $('.delete-review-btn').on('click', function(e) {
        e.preventDefault();
        var reviewId = $(this).data('id');
        var $reviewCard = $('#review-card-' + reviewId);

        if (confirm('Are you sure you want to delete this review?')) {
            $.ajax({
                type: 'POST',
                url: '{% url "delete_review" 0 %}'.replace(0, reviewId),  // Correct URL
                data: {
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                success: function(response) {
                    alert(response.message);
                    $reviewCard.remove();  // Remove the review card on success
                },
                error: function(xhr, status, error) {
                    alert('An error occurred while trying to delete the review.');
                }
            });
        }
    });

    // AJAX Edit Review - Redirect to edit page for now
    $('.edit-review-btn').on('click', function(e) {
        e.preventDefault();
        var reviewId = $(this).data('id');
        window.location.href = '{% url "edit_review" 0 %}'.replace(0, reviewId);
    });
</script>
{% endblock %}
